#/bin/bash

CODE_DIR="/data/genericrhel6/src/dynamicua.cdn.mozilla.net/dynamicua"
FILE_URL="https://hg.mozilla.org/mozilla-central/raw-file/tip/b2g/app/ua-update.json.in"
FILE_REVISION_NAME="file_revision.txt"
FILE_LATEST_REVISION=$(curl -s https://hg.mozilla.org/mozilla-central/file/tip/b2g/app/ua-update.json.in | grep -A1 '<td>changeset' | awk -F '[">]' '{print $9}' | awk -F '[</a]' '{print $1}' | grep -v '^$')
B2G_APP_ID="{3c2e2abc-06d4-11e1-ac3b-374f68613e61}"
FILENAME=$B2G_APP_ID
VERSION=$(cat /data/genericrhel6/src/dynamicua.cdn.mozilla.net/version.txt)
VERSION_DIR=$CODE_DIR/$VERSION

function checkretval(){
    retval=$?
    if [[ $retval -gt 0 ]]; then
        echo "Error!!! Exit status of the last command was $retval"
        exit $retval
    fi
}

{


if [ ! -d $VERSION_DIR ]
then
    mkdir $VERSION_DIR
    checkretval
fi

if [ ! -f $CODE_DIR/$FILE_REVISION_NAME ]
then
    curl -s https://hg.mozilla.org/mozilla-central/file/tip/b2g/app/ua-update.json.in | grep -A1 '<td>changeset' | awk -F '[">]' '{print $9}' | awk -F '[</a]' '{print $1}' | grep -v '^$' > $CODE_DIR/$FILE_REVISION_NAME
fi

FILE_DEPLOYED_REVISION=$(cat $CODE_DIR/$FILE_REVISION_NAME)

if [ $FILE_DEPLOYED_REVISION == $FILE_LATEST_REVISION ]
then
    exit 0
fi

# get file from Mercurial
curl -s $FILE_URL -o $VERSION_DIR/$FILENAME
checkretval

# remove JS comments from file
sed -i 's/\/\/.*$//g' $VERSION_DIR/$FILENAME
checkretval

# verify we have valid json before pushing
cat $VERSION_DIR/$FILENAME | json_verify > /dev/null
checkretval

#deploy the code
/data/genericrhel6/deploy dynamicua.cdn.mozilla.net

}
